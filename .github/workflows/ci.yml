name: CI

on:
  push:
    branches: [main, develop]
  pull_request:

jobs:
  backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install backend deps
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run tests
        run: |
          cd backend
          pytest tests/ -v
        env:
          DATABASE_URL: sqlite:///:memory:
          JWT_SECRET: test_secret
          DEMO_MODE: true
      
      - name: Import check
        run: |
          cd backend
          python -c "from app.main import app; print('✓ Backend imports OK')"
      
      - name: Check API starts
        run: |
          cd backend
          timeout 10 uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          sleep 5
          curl -f http://localhost:8000/healthz || exit 1
          echo "✓ Backend health check passed"

  frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      
      - name: Install pnpm
        run: npm install -g pnpm
      
      - name: Install dependencies
        run: |
          cd frontend
          pnpm install
      
      - name: Type check
        run: |
          cd frontend
          pnpm tsc --noEmit || echo "⚠ Type errors found (non-blocking)"
      
      - name: Build
        run: |
          cd frontend
          pnpm build
        env:
          NEXT_PUBLIC_API_BASE: http://localhost:8000
      
      - name: Check build output
        run: |
          cd frontend
          ls -la .next/
          echo "✓ Frontend build successful"

  integration:
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install backend deps
        run: |
          cd backend
          pip install -r requirements.txt
      
      - name: Run integration smoke test
        run: |
          cd backend
          python -c "from app.db import init_db; init_db(); print('✓ DB initialized')"
          uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          sleep 5
          
          # Test registration
          curl -X POST http://localhost:8000/auth/register \
            -H "Content-Type: application/json" \
            -d '{"email":"ci@example.com","password":"TestPass123!"}' \
            -o /tmp/register.json
          
          cat /tmp/register.json
          TOKEN=$(cat /tmp/register.json | python3 -c "import sys,json; print(json.load(sys.stdin)['access_token'])")
          echo "✓ Registration successful"
          
          # Test /me endpoint
          curl -X GET http://localhost:8000/me \
            -H "Authorization: Bearer $TOKEN" \
            -o /tmp/me.json
          
          cat /tmp/me.json
          echo "✓ Integration test passed"
        env:
          DATABASE_URL: sqlite:///./test.db
          JWT_SECRET: test_secret
          DEMO_MODE: true
